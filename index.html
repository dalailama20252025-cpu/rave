<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaveClone – Embedded YouTube Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>  <!-- Google API Client for Search -->
    <style>
        #queue, #searchResults { max-height: 300px; overflow-y: auto; }
        #queue li, #searchResults .result { transition: background-color 0.2s; cursor: pointer; }
        #queue li:hover, #searchResults .result:hover { background-color: rgba(59, 130, 246, 0.1); }
        #queue li.current, #searchResults .result.selected { background-color: #3b82f6; color: white; }
        #log { max-height: 200px; overflow-y: auto; background-color: #f9fafb; }
        .log-entry { margin-bottom: 4px; padding: 2px 0; }
        .log-entry.error { color: #ef4444; }
        #player { aspect-ratio: 16/9; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-blue-600 text-white p-4 shadow-md">
        <h1 class="text-2xl font-bold">RaveClone – Synced Player</h1>
        <p class="text-blue-100">Search & embed YouTube with full controls</p>
    </header>

    <div class="flex flex-1 p-4 gap-4">
        <aside class="w-80 bg-white rounded-lg shadow p-4 flex flex-col gap-4">
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Your Name</label>
                <input type="text" id="userName" value="TestUser" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex gap-2 mt-2">
                    <button id="createBtn" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition">Create Room</button>
                    <button id="joinBtn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">Join Room</button>
                </div>
                <input type="text" id="roomCode" placeholder="Room Code" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2">
            </div>

            <!-- Search Section -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">YouTube Search</label>
                <div class="flex gap-2">
                    <input type="text" id="searchInput" placeholder="Search videos (e.g., 'funny cats')" class="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="searchBtn" class="bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600 transition">Search</button>
                </div>
                <div id="searchResults" class="bg-gray-50 rounded-md p-2 hidden"></div>
            </div>

            <!-- Load Section -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Or Load by ID/URL</label>
                <input type="text" id="videoInput" placeholder="Video ID or URL" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="loadBtn" class="w-full bg-purple-600 text-white py-2 rounded-md hover:bg-purple-700 transition">Load Video</button>
            </div>

            <!-- Controls -->
            <div class="space-y-2">
                <h3 class="text-sm font-medium text-gray-700">Player Controls</h3>
                <div class="flex gap-2 flex-wrap">
                    <button id="prevBtn" class="bg-gray-500 text-white py-1 px-3 rounded-md hover:bg-gray-600 text-sm">⏮ Prev</button>
                    <button id="rewindBtn" class="bg-gray-400 text-white py-1 px-3 rounded-md hover:bg-gray-500 text-sm">-10s</button>
                    <button id="playBtn" class="bg-green-500 text-white py-1 px-3 rounded-md hover:bg-green-600 text-sm">▶ Play</button>
                    <button id="pauseBtn" class="bg-orange-500 text-white py-1 px-3 rounded-md hover:bg-orange-600 text-sm">⏸ Pause</button>
                    <button id="forwardBtn" class="bg-gray-400 text-white py-1 px-3 rounded-md hover:bg-gray-500 text-sm">+10s</button>
                    <button id="nextBtn" class="bg-gray-500 text-white py-1 px-3 rounded-md hover:bg-gray-600 text-sm">⏭ Next</button>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-700">Volume</label>
                    <input type="range" id="volumeSlider" min="0" max="100" value="50" class="flex-1">
                </div>
            </div>

            <!-- Chat -->
            <div class="space-y-2 flex-1">
                <h3 class="text-sm font-medium text-gray-700">Chat</h3>
                <input type="text" id="chatMsg" placeholder="Type message..." class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="chatBtn" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition">Send</button>
            </div>
        </aside>

        <main class="flex-1 bg-white rounded-lg shadow p-4 flex flex-col gap-4">
            <!-- Embedded Player -->
            <div class="flex justify-center">
                <div id="player" class="w-full max-w-4xl bg-black rounded-lg"></div>
            </div>

            <!-- Queue -->
            <div id="queue" class="space-y-2">
                <h3 class="text-lg font-medium text-gray-700">Queue</h3>
                <ul id="queueList" class="space-y-1"></ul>
                <p id="emptyQueue" class="text-gray-500 italic hidden">No videos queued.</p>
            </div>

            <!-- Log -->
            <div id="log" class="bg-gray-50 rounded-md p-3">
                <h4 class="text-sm font-medium text-gray-600 mb-2">Log</h4>
                <div id="logContent"></div>
            </div>
        </main>
    </div>

    <script>
        const API_KEY = 'YOUR_API_KEY';  // Replace with your YouTube Data API v3 key
        const socket = io('http://localhost:3000');
        let player, playerReady = false;
        let currentQueue = [], currentIndex = 0;

        function log(msg, isError = false) {
            const logContent = document.getElementById('logContent');
            const className = isError ? 'error' : '';
            logContent.innerHTML += `<div class="log-entry ${className} text-sm">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        // Event Listeners
        ['createBtn', 'joinBtn', 'loadBtn', 'searchBtn', 'playBtn', 'pauseBtn', 'nextBtn', 'prevBtn', 'rewindBtn', 'forwardBtn', 'chatBtn'].forEach(id => {
            document.getElementById(id).addEventListener('click', window[id.replace('Btn', '') + 'Handler'] || (() => {}));
        });
        document.getElementById('chatMsg').addEventListener('keypress', e => e.key === 'Enter' && sendChatHandler());
        document.getElementById('volumeSlider').addEventListener('input', e => {
            if (playerReady) player.setVolume(e.target.value);
        });

        // Search Handler
        function searchBtnHandler() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return log('Enter search term!', true);
            if (!API_KEY || API_KEY === 'YOUR_API_KEY') return log('Add your API key to code!', true);

            gapi.load('client', () => {
                gapi.client.setApiKey(API_KEY).then(() => {
                    gapi.client.youtube.search.list({
                        part: 'snippet',
                        q: query,
                        type: 'video',
                        maxResults: 10,
                        order: 'relevance'
                    }).then(response => {
                        displaySearchResults(response.result.items);
                    }).catch(e => log('Search Error: ' + e, true));
                });
            });
        }

        function displaySearchResults(items) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = items.map(item => `
                <div class="result p-3 border-b border-gray-200 hover:bg-blue-50 rounded-md" onclick="loadFromSearch('${item.id.videoId}', '${item.snippet.title}')">
                    <img src="${item.snippet.thumbnails.medium.url}" alt="${item.snippet.title}" class="w-20 h-15 object-cover rounded mr-3 float-left">
                    <div>
                        <h4 class="font-medium">${item.snippet.title}</h4>
                        <p class="text-sm text-gray-600">${item.snippet.channelTitle} • ${item.snippet.publishedAt.split('T')[0]}</p>
                    </div>
                    <div class="clear-both"></div>
                </div>
            `).join('');
        }

        function loadFromSearch(videoId, title) {
            log(`Loaded from search: ${title}`);
            document.getElementById('videoInput').value = videoId;
            loadVideoHandler();  // Trigger load
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('searchInput').value = '';
        }

        // Load Video (from ID/URL or search)
        function loadVideoHandler() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase().trim();
            if (!roomCode) return log('Join room first!', true);
            let videoId = document.getElementById('videoInput').value.trim();
            // Parse ID if URL
            const regex = /v=([^&]+)/;
            const match = videoId.match(regex);
            videoId = match ? match[1] : videoId;
            if (!videoId) return log('Enter valid ID/URL!', true);

            socket.emit('load-media', { roomCode, media: { type: 'youtube', id: videoId } });
            loadYouTubePlayer(videoId);
            document.getElementById('videoInput').value = '';
        }

        // YouTube Player
        function loadYouTubePlayer(videoId) {
            if (typeof YT === 'undefined') {
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                document.body.appendChild(tag);
                window.onYouTubeIframeAPIReady = () => initPlayer(videoId);
            } else {
                initPlayer(videoId);
            }
        }

        function initPlayer(videoId) {
            if (player) player.destroy();
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    origin: 'http://localhost:3000',
                    enablejsapi: 1,
                    rel: 0,
                    modestbranding: 1,
                    controls: 1,  // Show YouTube controls
                    playsinline: 1
                },
                events: {
                    'onReady': () => { playerReady = true; log('Player ready'); player.setVolume(50); },
                    'onError': e => log(`Error: ${e.data}`, true)
                }
            });
        }

        // Controls Handlers
        function playBtnHandler() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase().trim();
            if (!roomCode) return log('Join room!', true);
            const currentTime = playerReady ? player.getCurrentTime() : 0;
            socket.emit('play', { roomCode, currentTime });
            if (playerReady) player.playVideo();
        }

        function pauseBtnHandler() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase().trim();
            if (!roomCode) return log('Join room!', true);
            socket.emit('pause', { roomCode });
            if (playerReady) player.pauseVideo();
        }

        function forwardBtnHandler() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase().trim();
            if (!roomCode) return log('Join room!', true);
            const newTime = (playerReady ? player.getCurrentTime() : 0) + 10;
            socket.emit('seek', { roomCode, newTime });
            if (playerReady) player.seekTo(newTime, true);
        }

        function rewindBtnHandler() {
            const roomCode = document.getElementById('roomCode').value.toUpperCase().trim();
            if (!roomCode) return log('Join room!', true);
            const newTime = Math.max(0, (playerReady ? player.getCurrentTime() : 0) - 10);
            socket.emit('seek', { roomCode, newTime });
            if (playerReady) player.seekTo(newTime, true);
        }

        // Queue/Other (from previous – addToQueue, nextVideo, etc.)
        function addToQueue() { /* Implement as before */ }
        function nextVideo() { /* Socket emit 'next-video' */ }
        function prevVideo() { /* Socket emit 'prev-video' */ }
        function sendChatHandler() { /* Chat emit */ }
        function createRoom() { /* Emit 'create-room' */ }
        function joinRoom() { /* Emit 'join-room' */ }

        // Socket Events (as before – sync-play, etc.)
        socket.on('sync-play', ({ currentTime, timestamp }) => {
            if (playerReady) {
                const offset = (Date.now() - timestamp) / 1000;
                player.seekTo(currentTime + offset, true);
                player.playVideo();
            }
        });
        // ... (other events like media-updated, room-state, etc.)

        // Init
        gapi.load('client', () => {});  // Preload for search
    </script>
</body>
</html>